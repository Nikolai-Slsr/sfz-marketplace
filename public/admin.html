<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFZ Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 24px; border-radius: 16px; text-align: center; }
        .stat-card h3 { font-size: 2.5rem; margin-bottom: 8px; }
        .bug-list { background: var(--card); border-radius: 16px; padding: 24px; }
        .bug-item { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .bug-item:last-child { border-bottom: none; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-open { background: #fee2e2; color: #991b1b; }
        .status-closed { background: #dcfce7; color: #166534; }
        .admin-login { max-width: 400px; margin: 100px auto; background: var(--card); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); }
    </style>
</head>
<body>
    <div class="container">
        <div id="adminPanel">
            <header style="margin-bottom:40px">
                <div class="logo">SFZ Admin</div>
                <button onclick="logoutAdmin()" class="btn-secondary">Abmelden</button>
            </header>

            <div class="admin-grid">
                <div class="stat-card">
                    <h3 id="statUsers">0</h3>
                    <p>Sch√ºler</p>
                </div>
                <div class="stat-card">
                    <h3 id="statListings">0</h3>
                    <p>Anzeigen</p>
                </div>
                <div class="stat-card">
                    <h3 id="statBugs">0</h3>
                    <p>Bugs/Feedback</p>
                </div>
            </div>

            <div class="bug-list">
                <h2>Bug Reports & Feedback</h2>
                <div id="bugsList"></div>
            </div>

            <div class="bug-list" style="margin-top: 40px;">
                <h2>Benutzerverwaltung</h2>
                <div id="usersList" style="overflow-x: auto;"></div>
            </div>

            <div class="bug-list" style="margin-top: 40px; border-left: 5px solid #ef4444;">
                <h2>üõ°Ô∏è Sicherheits-Radar</h2>
                <div id="securityLogs" style="font-family:monospace; font-size: 0.85rem; max-height:300px; overflow-y:auto; background:#1e293b; color:#cbd5e1; padding:16px; border-radius:8px; line-height:1.6;">Lade Logs...</div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;

        function escapeHtml(text) {
            if (!text) return '';
            return String(text).replace(/[&<>"']/g, function(m) {
                switch (m) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#039;';
                }
            });
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    const user = await res.json();
                    if (user.is_admin) {
                        currentUserId = user.id;
                        loadStats();
                        loadBugs();
                        loadUsers();
                        loadRadar();
                        return;
                    }
                }
            } catch (e) {}
            alert('Zugriff verweigert. Bitte logge dich auf der Hauptseite als Admin ein.');
            window.location.href = '/';
        }

        checkAuth();

        async function logoutAdmin() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            if (!res.ok) return;
            const stats = await res.json();
            document.getElementById('statUsers').textContent = stats.users;
            document.getElementById('statListings').textContent = stats.listings;
            document.getElementById('statBugs').textContent = stats.bugs;
        }

        async function loadUsers() {
            const res = await fetch('/api/admin/users');
            if (!res.ok) return;
            const users = await res.json();
            
            const container = document.getElementById('usersList');
            if (users.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);padding:24px">Keine Benutzer vorhanden.</p>';
                return;
            }
            
            let html = '<table style="width:100%; border-collapse: collapse;"><thead><tr style="text-align:left; border-bottom: 1px solid var(--border);color:var(--text-light);"><th style="padding:12px;">Name</th><th style="padding:12px;">Klasse</th><th style="padding:12px;">Rolle</th><th style="padding:12px;">Aktionen</th></tr></thead><tbody>';
            
            users.forEach(user => {
                const isAdmin = user.is_admin === 1;
                const isSelf = user.id === currentUserId;
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding:12px;"><strong>${escapeHtml(user.name)}</strong></td>
                    <td style="padding:12px;">${escapeHtml(user.grade) || '-'}</td>
                    <td style="padding:12px;">
                        <span class="status-badge ${isAdmin ? 'status-closed' : 'status-open'}" style="background:${isAdmin ? '#e0f2fe' : '#f1f5f9'}; color:${isAdmin ? '#0369a1' : '#64748b'}">
                            ${isAdmin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td style="padding:12px;">
                        ${!isSelf ? `
                        <button onclick="toggleAdminRole(${user.id}, ${!isAdmin})" class="status-badge" style="border:none; cursor:pointer; background:${isAdmin ? '#f1f5f9' : '#e0f2fe'}; color:${isAdmin ? '#64748b' : '#0369a1'}; margin-right:8px;">
                            ${isAdmin ? 'Admin entfernen' : 'Zum Admin machen'}
                        </button>
                        <button onclick="deleteUser(${user.id})" class="status-badge status-open" style="border:none; cursor:pointer;">
                            L√∂schen
                        </button>
                        ` : '<span style="color:var(--text-light); font-size: 0.8rem;">(Du)</span>'}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function toggleAdminRole(userId, makeAdmin) {
            if (!confirm(`Soll der Nutzer wirklich ${makeAdmin ? 'zum Admin gemacht' : 'Admin-Rechte entzogen'} werden?`)) return;
            
            const res = await fetch(`/api/admin/users/${userId}/role`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({is_admin: makeAdmin})
            });
            
            if (res.ok) {
                loadUsers();
            } else {
                alert('Fehler beim √Ñndern der Rolle.');
            }
        }

        async function deleteUser(userId) {
            if (!confirm(`WARNUNG: Soll der Benutzer wirklich gel√∂scht werden? Alle Anzeigen und Daten werden unwiderruflich entfernt!`)) return;
            
            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                loadUsers();
                loadStats(); // Refresh stats too
            } else {
                const data = await res.json();
                alert('Fehler beim L√∂schen: ' + (data.error || 'Unbekannt'));
            }
        }

        async function loadBugs() {
            const res = await fetch('/api/bugs');
            if (!res.ok) return;
            const bugs = await res.json();
            
            const container = document.getElementById('bugsList');
            if (bugs.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);padding:24px">Keine Bug Reports vorhanden.</p>';
                return;
            }
            
            container.innerHTML = bugs.map(bug => `
                <div class="bug-item">
                    <div>
                        <strong>${escapeHtml(bug.title)}</strong>
                        <p style="color:var(--text-light);margin-top:4px">${escapeHtml(bug.description?.substring(0, 100))}...</p>
                        <small>${escapeHtml(bug.category)} ‚Ä¢ ${escapeHtml(bug.reporter)} ‚Ä¢ ${new Date(bug.created_at).toLocaleDateString()}</small>
                    </div>
                    <select onchange="updateBugStatus(${bug.id}, this.value)" class="status-badge status-${bug.status}">
                        <option value="open" ${bug.status === 'open' ? 'selected' : ''}>Offen</option>
                        <option value="closed" ${bug.status === 'closed' ? 'selected' : ''}>Geschlossen</option>
                    </select>
                </div>
            `).join('');
        }

        async function loadRadar() {
            try {
                const res = await fetch('/api/admin/logs');
                if (!res.ok) return;
                const logs = await res.json();
                
                const container = document.getElementById('securityLogs');
                if (logs.length === 0) {
                    container.innerHTML = '<span style="color:#94a3b8">Bisher keine Auff√§lligkeiten.</span>';
                    return;
                }
                
                container.innerHTML = logs.map(l => {
                    let color = '#38bdf8'; // info
                    if (l.event_type.includes('FAIL') || l.event_type.includes('ERROR')) color = '#f87171'; // red
                    if (l.event_type.includes('LIMIT')) color = '#fbbf24'; // orange
                    
                    return `<div style="padding:4px 0; border-bottom:1px solid #334155;">
                        <span style="color:#64748b; margin-right:8px">[${new Date(l.created_at).toLocaleTimeString()}]</span>
                        <strong style="color:${color}">${l.event_type}</strong>
                        <span style="color:#94a3b8"> (${l.ip_address})</span>: 
                        ${escapeHtml(l.details)}
                    </div>`;
                }).join('');
            } catch(e) {}
        }

        async function updateBugStatus(id, status) {
            await fetch(`/api/bugs/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({status})
            });
            loadBugs();
        }
    </script>
</body>
</html>
